# 媒体地图浏览器（本地优先）

一个本地运行的 Web 工具：扫描本机目录内图片/视频，解析 GPS 与拍摄时间，并在世界地图上显示缩略图聚合点位（类似相册地图视图）。

## 功能

- 世界地图渲染：缩放、拖拽、底图切换
- 本地目录扫描：递归扫描图片/视频并显示进度
- 元数据解析：GPS + 拍摄时间（图片/视频）
- 地图缩略图聚合：密集区域自动合并
- 预览：点击可查看大图或播放视频
- 筛选：按关键字、时间范围、媒体类型过滤
- 未定位列表：展示没有 GPS 的文件
- 缓存：按 `path + mtime + size` 缓存元数据，加速重复扫描
- 兼容预览：对浏览器不直接支持的图片格式（如 HEIC/HEIF）自动转 JPEG 预览
- 缩略图与预览采用本地磁盘缓存（成功与失败都缓存），减少重复转码导致的卡顿
- 目录扫描结果缓存：可查看历史目录、重新加载缓存结果、删除单条缓存、清空全部缓存
- 支持勾选多个目录缓存并一次性合并加载到地图视图
- 新扫描目录完成后会自动“追加到当前已加载缓存集合”进行合并显示（不覆盖已有目录结果）
- 地名区域着色：上传地名列表（txt/csv）或直接输入，地图按区域边界着色显示（匹配区域高亮，其他区域白色）
- 区域模式支持两种粒度：全球按国家边界，中国按地级市边界
- 区域模式支持导出当前视图为 PNG 图片
- 控制面板采用“工作表分页”样式：媒体模式与区域模式通过底部 sheet tab 切换，避免同页堆叠
- 页面布局为左侧固定操作栏、右侧地图区；目录扫描控件仅在“媒体模式”页签显示

## 依赖建议

- Python 3.10+
- `exiftool`（读取图片/视频 GPS/EXIF）
- `ffmpeg`（生成视频缩略图）
- Python 包 `Pillow`（图片缩略图）

macOS 示例：

```bash
brew install exiftool ffmpeg
python3 -m pip install pillow
```

## 运行

在仓库根目录执行：

```bash
python3 media-map-browser/server.py --host 127.0.0.1 --port 8765
```

浏览器打开：

```text
http://127.0.0.1:8765
```

输入需要扫描的本机目录绝对路径（例如 `/Users/xxx/Pictures`）并开始扫描。
也可以点击页面的“选择目录”按钮，调用系统目录选择器自动回填路径。

## 说明

- 该工具默认仅本地处理，不上传媒体到远端。
- 地图瓦片来自在线公开服务（OpenStreetMap/OpenTopoMap/CARTO），需联网加载地图底图。
- 区域着色的边界数据会通过服务端下载并缓存（世界国家 + 中国省级），首次加载需要联网。
- 中国地级市参考数量：293（截至 2025 年 8 月公开口径）。
- 区域着色的边界数据会通过服务端下载并缓存（世界国家 + 中国地级市），首次加载需要联网。
- 如果缺少 `Pillow` 或 `ffmpeg`，仍可运行，但部分缩略图会降级为占位图。
- “选择目录”按钮在 macOS 使用 `osascript`，在 Linux 尝试 `zenity/kdialog`，在 Windows 使用 `powershell`。
- 若系统缺少上述目录选择器，可改用手动输入目录路径。
- 缓存文件位于 `media-map-browser/.cache/`（元数据、缩略图、预览图、目录扫描结果）。
